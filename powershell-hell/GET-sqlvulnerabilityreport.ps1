param(
    [Parameter(Mandatory = $true)]
    [string]$SqlInstance,

    [string]$OutputPath = ".\SqlSecurityReport.html"
)

Write-Host "Collecting security data from $SqlInstance ..."

# Create a container for all results
$sections = @()

function Add-Section {
    param($Title, $Data)
    if ($Data) {
        $html = $Data | ConvertTo-Html -Fragment -PreContent "<h2>$Title</h2>"
        $script:sections += $html
    } else {
        $script:sections += "<h2>$Title</h2><p>No data returned.</p>"
    }
}

# Version & Build
Add-Section -Title "SQL Server Version & Patch Level" -Data (Get-DbaBuildReference -SqlInstance $SqlInstance)

# Features & Configurations
Add-Section -Title "Surface Area: Enabled Features"       -Data (Get-DbaFeature -SqlInstance $SqlInstance)
Add-Section -Title "sp_configure Settings"                -Data (Get-DbaSpConfigure -SqlInstance $SqlInstance)
Add-Section -Title "TCP/IP & Protocols"                   -Data (Get-DbaTcpPort -SqlInstance $SqlInstance)

# Security-sensitive configuration checks
Add-Section -Title "xp_cmdshell Status"      -Data (Get-DbaSpConfigure -SqlInstance $SqlInstance | Where-Object Name -eq "xp_cmdshell")
Add-Section -Title "CLR Integration Status"  -Data (Get-DbaSpConfigure -SqlInstance $SqlInstance | Where-Object Name -eq "clr enabled")

# Authentication & Login Audits
Add-Section -Title "Login Audit Policy"      -Data (Get-DbaLoginAudit -SqlInstance $SqlInstance)
Add-Section -Title "Orphaned Users"          -Data (Get-DbaOrphanUser -SqlInstance $SqlInstance)

# Database Permissions & Roles
Add-Section -Title "Database Role Members"   -Data (Get-DbaDbRoleMember -SqlInstance $SqlInstance)

# Encryption & Endpoint Security
Add-Section -Title "Endpoints"               -Data (Get-DbaEndpoint -SqlInstance $SqlInstance)

# Backup health
Add-Section -Title "Last Backup Summary"     -Data (Get-DbaLastBackup -SqlInstance $SqlInstance)

# TempDB Best Practices
Add-Section -Title "TempDB Configuration Analysis" -Data (Test-DbaTempDbConfig -SqlInstance $SqlInstance)

# Disk & Power Checks (Host-level)
Add-Section -Title "Power Plan"              -Data (Test-DbaPowerPlan)
Add-Section -Title "Disk Space"              -Data (Test-DbaDiskSpace -SqlInstance $SqlInstance)

# Build report
$fullHtml = @"
<html>
<head>
<title>SQL Server Vulnerability Report - $SqlInstance</title>
<style>
body { font-family: Arial; margin: 30px; }
h1 { color: #1d4ed8; }
h2 { color: #0f172a; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
table { border-collapse: collapse; width: 100%; margin-bottom: 25px; }
th, td { border: 1px solid #ccc; padding: 6px; font-size: 12px; }
th { background: #e2e8f0; }
</style>
</head>
<body>
<h1>SQL Server Vulnerability & Security Report</h1>
<p><strong>Instance:</strong> $SqlInstance</p>
<p><strong>Generated:</strong> $(Get-Date)</p>
$($sections -join "`n")
</body></html>
"@

$fullHtml | Out-File -FilePath $OutputPath -Encoding UTF8

Write-Host "Report saved to $OutputPath"



.\Get-SqlVulnerabilityReport.ps1 -SqlInstance "SIMPODBDEVURSB" -OutputPath "F:\SecurityReports\SecurityReport.html"
