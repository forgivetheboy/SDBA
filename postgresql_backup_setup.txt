#!/bin/bash
# PostgreSQL Backup and Maintenance Setup Script
# Universal Setup for Linux VMs with PostgreSQL
# Run as root: sudo bash postgresql_backup_setup.txt

set -e

# Configuration - UPDATE THESE VALUES FOR YOUR ENVIRONMENT
SERVER_NAME="your-server-name"
SERVER_IP="192.168.x.x"
PG_VERSION="15"

# SMB Configuration
SMB_SERVER="192.168.180.161"
SMB_SHARE="db_backups$"
SMB_USER="sqlservice"
SMB_DOMAIN="URSB.LOCAL"
SMB_PASSWORD="your_smb_password"

# SMTP Configuration
SMTP_HOST="smtp.ursb.go.ug"
SMTP_PORT="587"
SMTP_USER="dbalerts@ursb.go.ug"
SMTP_PASSWORD="your_smtp_password"
SMTP_FROM="dbalerts@ursb.go.ug"

# Email Recipients (comma-separated)
ALERT_GROUP="admin@yourdomain.com,your@email.com"
SDBA_EMAIL="your@email.com"

# Backup Configuration
BACKUP_RETENTION_DAYS="30"
LOCAL_BACKUP_DIR="/var/backups/postgresql"
SMB_MOUNT_POINT="/mnt/db_backup_share"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[ERROR] $1${NC}" >&2
}

warn() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}

# Update system
log "Updating system packages..."
apt-get update && apt-get upgrade -y

# Install required packages
log "Installing required packages..."
apt-get install -y postgresql-client-${PG_VERSION} postgresql-${PG_VERSION} \
    msmtp msmtp-mta cifs-utils cron logrotate ca-certificates rsync

# Create directories
log "Creating directories..."
mkdir -p /opt/pg-maintenance/{scripts,logs,reports}
mkdir -p ${LOCAL_BACKUP_DIR}/base_backups
mkdir -p /mnt/db_backup_share
mkdir -p /mnt/db_backups

# SMB Mount Configuration
log "Configuring SMB mounts..."
cat > /etc/fstab << EOF
//${SMB_SERVER}/${SMB_SHARE} /mnt/db_backup_share cifs username=${SMB_USER},password=${SMB_PASSWORD},domain=${SMB_DOMAIN},file_mode=0755,dir_mode=0755,soft,nounix,mapposix,rsize=4194304,wsize=4194304,bsize=1048576,retrans=1,echo_interval=60,actimeo=1,closetimeo=1,_netdev 0 0
//${SMB_SERVER}/${SMB_SHARE} /mnt/db_backups cifs username=${SMB_USER},password=${SMB_PASSWORD},domain=${SMB_DOMAIN},file_mode=0644,dir_mode=0755,iocharset=utf8,soft,nounix,serverino,mapposix,rsize=4194304,wsize=4194304,bsize=1048576,retrans=1,echo_interval=60,actimeo=1,closetimeo=1,_netdev 0 0
EOF

# Mount SMB shares
log "Mounting SMB shares..."
mount -a

# Create SMB subdirectories
mkdir -p /mnt/db_backup_share/${SERVER_NAME}/{base_backups,wal_archive,autogenerated-reports}

# MSMTP Configuration
log "Configuring MSMTP..."
cat > /etc/msmtprc << EOF
# MSMTP Configuration for PostgreSQL Alerts
# Server: ${SERVER_NAME} (${SERVER_IP})

defaults
auth           login
tls            on
tls_starttls   on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
logfile        /var/log/msmtp.log

# SMTP Account
account        default
host           ${SMTP_HOST}
port           ${SMTP_PORT}
from           ${SMTP_FROM}
user           ${SMTP_USER}
password       ${SMTP_PASSWORD}
EOF

chmod 600 /etc/msmtprc

# Test SMTP
log "Testing SMTP configuration..."
echo "Test email from ${SERVER_NAME} - Setup Complete" | msmtp --debug --logfile /tmp/msmtp_test.log ${SDBA_EMAIL}

# Create alert script
log "Creating alert script..."
cat > /opt/pg-maintenance/scripts/send_alert.sh << 'EOF'
#!/bin/bash
# Send alert email
# Usage: send_alert.sh "Subject" "Message" "recipient1@example.com,recipient2@example.com"

SUBJECT="$1"
MESSAGE="$2"
RECIPIENTS="$3"

if [ -z "$SUBJECT" ] || [ -z "$MESSAGE" ] || [ -z "$RECIPIENTS" ]; then
    echo "Usage: $0 'Subject' 'Message' 'recipients'"
    exit 1
fi

# Create email content
EMAIL_FILE="/tmp/alert_email_$$.txt"
cat > "$EMAIL_FILE" << EMAIL_EOF
Subject: $SUBJECT
To: $RECIPIENTS
From: $SMTP_FROM

$MESSAGE

--
PostgreSQL Alert System
Server: $SERVER_NAME ($SERVER_IP)
Timestamp: $(date)
EMAIL_EOF

# Send email
msmtp --read-recipients --read-envelope-from "$RECIPIENTS" < "$EMAIL_FILE"

# Cleanup
rm -f "$EMAIL_FILE"
EOF

chmod +x /opt/pg-maintenance/scripts/send_alert.sh

# Create backup script
log "Creating backup script..."
cat > /opt/pg-maintenance/scripts/pg_basebackup.sh << EOF
#!/bin/bash
# PostgreSQL Base Backup Script

BACKUP_DIR_LOCAL="${LOCAL_BACKUP_DIR}/base_backups"
BACKUP_DIR_SMB="/mnt/db_backup_share/${SERVER_NAME}/base_backups"
LOG_FILE="/opt/pg-maintenance/logs/pg_basebackup.log"

# Ensure directories exist
mkdir -p "\$BACKUP_DIR_LOCAL"
mkdir -p "\$BACKUP_DIR_SMB"

# Generate backup filename
TIMESTAMP=\$(date +"%Y%m%d_%H%M%S")
BACKUP_NAME="base_backup_\${TIMESTAMP}"
BACKUP_FILE_LOCAL="\$BACKUP_DIR_LOCAL/\$BACKUP_NAME.tar.gz"
BACKUP_FILE_SMB="\$BACKUP_DIR_SMB/\$BACKUP_NAME.tar.gz"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] \$1" >> "\$LOG_FILE"
}

log "Starting PostgreSQL base backup: \$BACKUP_NAME"

# Perform backup
if pg_basebackup -D /tmp/pg_backup_\$\$ -Ft -z -Z 9 -X fetch --no-password --username=postgres; then
    mv /tmp/pg_backup_\$\$.tar.gz "\$BACKUP_FILE_LOCAL"
    cp "\$BACKUP_FILE_LOCAL" "\$BACKUP_FILE_SMB"

    # Send success alert
    /opt/pg-maintenance/scripts/send_alert.sh \
        "PostgreSQL Backup Success - ${SERVER_NAME}" \
        "Base backup completed successfully.\n\nBackup: \$BACKUP_NAME\nLocal: \$BACKUP_FILE_LOCAL\nSMB: \$BACKUP_FILE_SMB\nSize: \$(du -h "\$BACKUP_FILE_LOCAL" | cut -f1)" \
        "${ALERT_GROUP}"

    log "Backup completed successfully"
else
    # Send failure alert
    /opt/pg-maintenance/scripts/send_alert.sh \
        "PostgreSQL Backup FAILED - ${SERVER_NAME}" \
        "Base backup failed. Check logs for details." \
        "${SDBA_EMAIL}"

    log "Backup failed"
    exit 1
fi

# Cleanup old backups
find "\$BACKUP_DIR_LOCAL" -name "base_backup_*.tar.gz" -mtime +${BACKUP_RETENTION_DAYS} -delete
find "\$BACKUP_DIR_SMB" -name "base_backup_*.tar.gz" -mtime +${BACKUP_RETENTION_DAYS} -delete

log "Cleanup completed"
EOF

chmod +x /opt/pg-maintenance/scripts/pg_basebackup.sh

# Create WAL sync script
log "Creating WAL archive sync script..."
cat > /opt/pg-maintenance/scripts/wal_archive_sync.sh << EOF
#!/bin/bash
# WAL Archive Sync Script

WAL_DIR="/var/lib/postgresql/${PG_VERSION}/main/pg_wal"
SMB_WAL_DIR="/mnt/db_backup_share/${SERVER_NAME}/wal_archive"

# Ensure SMB directory exists
mkdir -p "\$SMB_WAL_DIR"

# Sync WAL files
rsync -av --delete "\$WAL_DIR/" "\$SMB_WAL_DIR/" --exclude="*.tmp" --exclude="archive_status"

# Check for sync errors
if [ \$? -eq 0 ]; then
    # Success - log only
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] WAL sync successful" >> /opt/pg-maintenance/logs/wal_sync.log
else
    # Failure - send alert
    /opt/pg-maintenance/scripts/send_alert.sh \
        "WAL Archive Sync FAILED - ${SERVER_NAME}" \
        "WAL archive synchronization failed. Check connectivity to SMB share." \
        "${SDBA_EMAIL}"
fi
EOF

chmod +x /opt/pg-maintenance/scripts/wal_archive_sync.sh

# Create system monitor script
log "Creating system monitor script..."
cat > /opt/pg-maintenance/scripts/system_monitor.sh << EOF
#!/bin/bash
# System Monitor Script

LOG_FILE="/opt/pg-maintenance/logs/system_monitor.log"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] \$1" >> "\$LOG_FILE"
}

alert() {
    SUBJECT="\$1"
    MESSAGE="\$2"
    RECIPIENT="\$3"

    /opt/pg-maintenance/scripts/send_alert.sh "\$SUBJECT" "\$MESSAGE" "\$RECIPIENT"
}

# Check PostgreSQL service
if ! systemctl is-active --quiet postgresql; then
    alert "PostgreSQL DOWN - ${SERVER_NAME}" "PostgreSQL service is not running on ${SERVER_NAME} (${SERVER_IP})" "${ALERT_GROUP}"
    log "ALERT: PostgreSQL service down"
fi

# Check disk space
DISK_USAGE=\$(df / | tail -1 | awk '{print \$5}' | sed 's/%//')
if [ "\$DISK_USAGE" -gt 85 ]; then
    alert "CRITICAL: Disk Space - ${SERVER_NAME}" "Disk usage is at \${DISK_USAGE}% on ${SERVER_NAME}" "${SDBA_EMAIL}"
    log "ALERT: Disk usage critical: \${DISK_USAGE}%"
elif [ "\$DISK_USAGE" -gt 70 ]; then
    alert "WARNING: Disk Space - ${SERVER_NAME}" "Disk usage is at \${DISK_USAGE}% on ${SERVER_NAME}" "${SDBA_EMAIL}"
    log "ALERT: Disk usage warning: \${DISK_USAGE}%"
fi

# Check CPU usage
CPU_USAGE=\$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - \$1}')
CPU_INT=\${CPU_USAGE%.*}
if [ "\$CPU_INT" -gt 85 ]; then
    alert "HIGH CPU Usage - ${SERVER_NAME}" "CPU usage is at \${CPU_USAGE}% on ${SERVER_NAME}" "${SDBA_EMAIL}"
    log "ALERT: High CPU usage: \${CPU_USAGE}%"
fi

# Check memory usage
MEM_USAGE=\$(free | grep Mem | awk '{printf "%.0f", \$3/\$2 * 100.0}')
if [ "\$MEM_USAGE" -gt 85 ]; then
    alert "HIGH Memory Usage - ${SERVER_NAME}" "Memory usage is at \${MEM_USAGE}% on ${SERVER_NAME}" "${SDBA_EMAIL}"
    log "ALERT: High memory usage: \${MEM_USAGE}%"
fi

# Check for failed login attempts (last 15 minutes)
FAILED_LOGINS=\$(journalctl -u ssh --since "15 minutes ago" | grep "Failed password" | wc -l)
if [ "\$FAILED_LOGINS" -gt 5 ]; then
    alert "Multiple Failed Logins - ${SERVER_NAME}" "\${FAILED_LOGINS} failed login attempts in the last 15 minutes on ${SERVER_NAME}" "${SDBA_EMAIL}"
    log "ALERT: \${FAILED_LOGINS} failed logins in 15 minutes"
fi

# Check temp file size
TEMP_SIZE=\$(du -s /tmp 2>/dev/null | awk '{print \$1}')
TEMP_SIZE_MB=\$((TEMP_SIZE / 1024))
if [ "\$TEMP_SIZE_MB" -gt 1024 ]; then
    alert "Large Temp Files - ${SERVER_NAME}" "Temp directory is \${TEMP_SIZE_MB}MB on ${SERVER_NAME}" "${SDBA_EMAIL}"
    log "ALERT: Large temp files: \${TEMP_SIZE_MB}MB"
fi

# Check backup freshness
LATEST_BACKUP=\$(find /mnt/db_backup_share/${SERVER_NAME}/base_backups -name "base_backup_*.tar.gz" -type f -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | cut -d' ' -f2-)
if [ -n "\$LATEST_BACKUP" ]; then
    BACKUP_AGE_HOURS=\$(( ( \$(date +%s) - \$(stat -c %Y "\$LATEST_BACKUP") ) / 3600 ))
    if [ "\$BACKUP_AGE_HOURS" -gt 35 ]; then
        alert "STALE Backup - ${SERVER_NAME}" "Latest backup is \${BACKUP_AGE_HOURS} hours old on ${SERVER_NAME}" "${SDBA_EMAIL}"
        log "ALERT: Stale backup: \${BACKUP_AGE_HOURS} hours old"
    fi
else
    alert "NO Backups Found - ${SERVER_NAME}" "No backups found in SMB share for ${SERVER_NAME}" "${SDBA_EMAIL}"
    log "ALERT: No backups found"
fi

log "System monitor check completed"
EOF

chmod +x /opt/pg-maintenance/scripts/system_monitor.sh

# Create other maintenance scripts
log "Creating additional maintenance scripts..."

# VACUUM ANALYZE
cat > /opt/pg-maintenance/scripts/vacuum_analyze.sh << EOF
#!/bin/bash
LOG_FILE="/opt/pg-maintenance/logs/vacuum_analyze.log"
echo "[$(date)] Starting VACUUM ANALYZE" >> "\$LOG_FILE"
if sudo -u postgres psql -d postgres -c "VACUUM ANALYZE;" >> "\$LOG_FILE" 2>&1; then
    /opt/pg-maintenance/scripts/send_alert.sh "VACUUM ANALYZE Success - ${SERVER_NAME}" "VACUUM ANALYZE completed successfully" "${ALERT_GROUP}"
else
    /opt/pg-maintenance/scripts/send_alert.sh "VACUUM ANALYZE Failed - ${SERVER_NAME}" "VACUUM ANALYZE failed. Check logs." "${SDBA_EMAIL}"
fi
EOF
chmod +x /opt/pg-maintenance/scripts/vacuum_analyze.sh

# Index bloat check
cat > /opt/pg-maintenance/scripts/index_bloat_check.sh << EOF
#!/bin/bash
LOG_FILE="/opt/pg-maintenance/logs/index_bloat_check.log"
REPORT_FILE="/opt/pg-maintenance/reports/index_bloat_\$(date +%Y%m%d).txt"
sudo -u postgres psql -d postgres -c "
SELECT
  schemaname, tablename, attname, n_distinct,
  correlation
FROM pg_stats
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
ORDER BY 1,2,3;
" > "\$REPORT_FILE" 2>> "\$LOG_FILE"
if [ -s "\$REPORT_FILE" ]; then
    /opt/pg-maintenance/scripts/send_alert.sh "Index Bloat Report - ${SERVER_NAME}" "Index statistics check completed. See attached report." "${ALERT_GROUP}"
fi
EOF
chmod +x /opt/pg-maintenance/scripts/index_bloat_check.sh

# WAL cleanup
cat > /opt/pg-maintenance/scripts/wal_archive_cleanup.sh << EOF
#!/bin/bash
SMB_WAL_DIR="/mnt/db_backup_share/${SERVER_NAME}/wal_archive"
find "\$SMB_WAL_DIR" -name "*.gz" -mtime +${BACKUP_RETENTION_DAYS} -delete 2>/dev/null || true
echo "[$(date)] WAL cleanup completed" >> /opt/pg-maintenance/logs/wal_cleanup.log
EOF
chmod +x /opt/pg-maintenance/scripts/wal_archive_cleanup.sh

# Daily performance report
cat > /opt/pg-maintenance/scripts/daily_perf_report.sh << EOF
#!/bin/bash
REPORT_FILE="/opt/pg-maintenance/reports/daily_perf_\$(date +%Y%m%d).txt"
sudo -u postgres psql -d postgres -c "
SELECT
  schemaname,
  tablename,
  n_tup_ins,
  n_tup_upd,
  n_tup_del,
  n_live_tup,
  n_dead_tup
FROM pg_stat_user_tables
ORDER BY n_dead_tup DESC
LIMIT 20;
" > "\$REPORT_FILE"
/opt/pg-maintenance/scripts/send_alert.sh "Daily Performance Report - ${SERVER_NAME}" "Daily performance report attached." "${ALERT_GROUP}"
EOF
chmod +x /opt/pg-maintenance/scripts/daily_perf_report.sh

# pg_amcheck
cat > /opt/pg-maintenance/scripts/pg_amcheck.sh << EOF
#!/bin/bash
LOG_FILE="/opt/pg-maintenance/logs/pg_amcheck.log"
if sudo -u postgres pg_amcheck --all --verbose >> "\$LOG_FILE" 2>&1; then
    echo "pg_amcheck passed" >> "\$LOG_FILE"
else
    /opt/pg-maintenance/scripts/send_alert.sh "pg_amcheck FAILED - ${SERVER_NAME}" "Integrity check failed. Check logs." "${SDBA_EMAIL}"
fi
EOF
chmod +x /opt/pg-maintenance/scripts/pg_amcheck.sh

# Create cron jobs
log "Setting up cron jobs..."
cat > /etc/cron.d/pg-maintenance << EOF
# PostgreSQL Maintenance Jobs - ${SERVER_NAME} (${SERVER_IP})
# Generated: $(date)

SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# 1. BACKUP JOBS
# Base backup - Daily at 11:59 PM
59 23 * * * root /opt/pg-maintenance/scripts/pg_basebackup.sh >> /opt/pg-maintenance/logs/pg_basebackup_cron.log 2>&1

# WAL archive sync - Every 5 minutes
*/5 * * * * root /opt/pg-maintenance/scripts/wal_archive_sync.sh > /dev/null 2>&1

# 2. VACUUM & ANALYZE - Daily at 2:00 AM
0 2 * * * root /opt/pg-maintenance/scripts/vacuum_analyze.sh >> /opt/pg-maintenance/logs/vacuum_cron.log 2>&1

# 3. INDEX MAINTENANCE - Saturday at 5:00 PM
0 17 * * 6 root /opt/pg-maintenance/scripts/index_bloat_check.sh >> /opt/pg-maintenance/logs/index_bloat_cron.log 2>&1

# 4. INTEGRITY CHECK - Daily at 7:00 AM
0 7 * * * root /opt/pg-maintenance/scripts/pg_amcheck.sh

# 5. CLEANUP & HOUSEKEEPING
# WAL archive cleanup - Sunday at 6:00 PM
0 18 * * 0 root /opt/pg-maintenance/scripts/wal_archive_cleanup.sh >> /opt/pg-maintenance/logs/wal_cleanup_cron.log 2>&1

# 6. SYSTEM MONITORING - Every 5 minutes
*/5 * * * * root /opt/pg-maintenance/scripts/system_monitor.sh

# 7. DAILY PERFORMANCE REPORT - Daily at 1:00 PM
0 13 * * * root /opt/pg-maintenance/scripts/daily_perf_report.sh >> /opt/pg-maintenance/logs/daily_report_cron.log 2>&1
EOF

# Set permissions
chown -R postgres:postgres /opt/pg-maintenance
chmod -R 755 /opt/pg-maintenance/scripts

# Create logrotate configuration
log "Setting up log rotation..."
cat > /etc/logrotate.d/pg-maintenance << EOF
/opt/pg-maintenance/logs/*.log {
    daily
    rotate 30
    compress
    missingok
    notifempty
    create 644 postgres postgres
    postrotate
        # Reload services if needed
    endscript
}
EOF

# Enable and start cron
log "Enabling cron service..."
systemctl enable cron
systemctl start cron

# Test backup
log "Testing backup script..."
/opt/pg-maintenance/scripts/pg_basebackup.sh

# Create README
log "Creating README documentation..."
cat > /opt/pg-maintenance/README.md << EOF
# PostgreSQL Maintenance Automation
## Server: ${SERVER_NAME} (${SERVER_IP})
## PostgreSQL Version: ${PG_VERSION}

---

## Directory Structure

/opt/pg-maintenance/
├── scripts/             # All maintenance scripts
├── logs/               # Job execution logs
└── reports/            # Generated reports

/mnt/db_backup_share/${SERVER_NAME}/
├── base_backups/       # Full database backups
├── wal_archive/        # WAL archive files
└── autogenerated-reports/   # Performance reports

---

## Scheduled Jobs

| Job | Schedule | Script | Alert Group |
|-----|----------|--------|-------------|
| pg_basebackup | Daily 11:59 PM | pg_basebackup.sh | ${ALERT_GROUP} |
| WAL Sync | Every 5 min | wal_archive_sync.sh | ${SDBA_EMAIL} (on failure) |
| VACUUM ANALYZE | Daily 2:00 AM | vacuum_analyze.sh | ${ALERT_GROUP} / ${SDBA_EMAIL} |
| Index Bloat Check | Saturday 5:00 PM | index_bloat_check.sh | ${ALERT_GROUP} |
| pg_amcheck | Daily 7:00 AM | pg_amcheck.sh | ${ALERT_GROUP} / ${SDBA_EMAIL} |
| WAL Cleanup | Sunday 6:00 PM | wal_archive_cleanup.sh | ${ALERT_GROUP} |
| System Monitor | Every 5 min | system_monitor.sh | ${SDBA_EMAIL} |
| Daily Perf Report | Daily 1:00 PM | daily_perf_report.sh | ${ALERT_GROUP} |

---

## Alert Recipients

- Support Group: ${ALERT_GROUP}
- SDBA: ${SDBA_EMAIL}

---

## System Alerts

| Alert | Threshold | Recipient |
|-------|-----------|-----------|
| Database Down | Service not running | ${ALERT_GROUP} |
| Disk Space Warning | 70% | ${SDBA_EMAIL} |
| Disk Space Critical | 85% | ${SDBA_EMAIL} |
| High CPU/Memory | >85% | ${SDBA_EMAIL} |
| Failed Logins | >5 in 15 min | ${SDBA_EMAIL} |
| Large Temp Files | >1GB | ${SDBA_EMAIL} |
| Stale Backup | >35 hours | ${SDBA_EMAIL} |

---

## Backup Configuration

- Retention: ${BACKUP_RETENTION_DAYS} days
- Local Path: ${LOCAL_BACKUP_DIR}/base_backups/
- SMB Path: \\\\${SMB_SERVER}\\${SMB_SHARE}$\\${SERVER_NAME}
- Mount Point: /mnt/db_backup_share/${SERVER_NAME}/

---

## Manual Commands

# Run backup manually
sudo /opt/pg-maintenance/scripts/pg_basebackup.sh

# Run VACUUM manually
sudo /opt/pg-maintenance/scripts/vacuum_analyze.sh

# Generate performance report
sudo /opt/pg-maintenance/scripts/daily_perf_report.sh

# Run system checks
sudo /opt/pg-maintenance/scripts/system_monitor.sh

# Check index bloat
sudo /opt/pg-maintenance/scripts/index_bloat_check.sh

# Run integrity check
sudo /opt/pg-maintenance/scripts/pg_amcheck.sh

---

## Log Files

# View recent logs
ls -lt /opt/pg-maintenance/logs/

# View system monitor log
tail -f /opt/pg-maintenance/logs/system_monitor.log

# View backup log
tail -f /opt/pg-maintenance/logs/pg_basebackup.log

---

## Configuration Files

- Cron Jobs: /etc/cron.d/pg-maintenance
- Log Rotation: /etc/logrotate.d/pg-maintenance
- SMTP Config: /etc/msmtprc
- SMB Mounts: /etc/fstab

---

## Created: $(date)
## Setup completed for: ${SERVER_NAME}
EOF

log "Setup completed successfully!"
log "Please review /opt/pg-maintenance/README.md for details"
log "Test email sent to ${SDBA_EMAIL}"
log "Initial backup created"

echo ""
echo "=========================================="
echo "PostgreSQL Backup Setup Complete!"
echo "=========================================="
echo "Server: ${SERVER_NAME} (${SERVER_IP})"
echo "Check logs: /opt/pg-maintenance/logs/"
echo "Documentation: /opt/pg-maintenance/README.md"
echo "=========================================="