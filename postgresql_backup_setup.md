# PostgreSQL Backup and Maintenance Setup Guide


# Backup Configuration (autocreate any missing dir)
BACKUP_RETENTION_DAYS="30"
LOCAL_BACKUP_DIR="/var/backups/postgresql"
SMB_MOUNT_POINT="/mnt/db_backup_share"
```

---

## ðŸš€ Automated Setup Script

Run this script as root on your target VM:


# PostgreSQL Backup and Maintenance Setup Script
# Run as root: sudo bash setup_postgresql_backup.sh

set -e

# Mount SMB shares mount -a, keep it mounted:
SMB_SERVER="192.168.180.161"
SMB_SHARE="\db_backups$\CLAIMANTS-DB"
SMB_USER="sqlservice"
SMB_DOMAIN="URSB.LOCAL"
SMB_PASSWORD="XtenDaH%2749..@SVR56!!"

# Create SMB subdirectories
mkdir -p /mnt/db_backup_share/${SERVER_NAME}/{base_backups,wal_archive,autogenerated-reports}

insatll msmtp and setup smtp: 
SMTP_HOST="smtp.ursb.go.ug"
SMTP_PORT="587"
SMTP_USER="dbalerts@ursb.go.ug"
SMTP_PASSWORD="de4]ddXC2y"
SMTP_FROM="dbalerts@ursb.go.ug"
Mail Subject/Display Name = " CLAIMANTS-DB Alerts."

with defaults
auth           login
tls            on
tls_starttls   on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
logfile        /var/log/msmtp.log



setup OPERATOR GROUPS :
1) CLAIMANTS-SUPPORT=
"Jerry-Opolot (jerry.opolot@ursb.go.ug; )
Chicco (moses.chicco@ursb.go.ug;)
Saul (saul.akankwasa@ursb.go.ug;)
Bob (bob.wabusa@ursb.go.ug; )
Emanuel (emanuel.okello@ursb.go.ug; )
Norman (norman.wolimbwa@ursb.go.ug)"

2) SDBA_OG="Chicco (moses.chicco@ursb.go.ug;)"
BACKUP_RETENTION_DAYS="30"




# Install required packages
log "Installing required packages..."
apt-get install -y postgresql-client-${PG_VERSION} postgresql-${PG_VERSION} \
    msmtp msmtp-mta cifs-utils cron logrotate ca-certificates

# Create directories (ignore if they already exist)

mkdir -p /opt/pg-maintenance/{scripts,logs,reports}
mkdir -p ${LOCAL_BACKUP_DIR}/base_backups
mkdir -p /mnt/db_backup_share
mkdir -p /mnt/db_backups



## ðŸ“ Directory Structure

\`\`\`
/opt/pg-maintenance/
â”œâ”€â”€ scripts/             # All maintenance scripts
â”œâ”€â”€ logs/               # Job execution logs
â””â”€â”€ reports/            # Generated reports

/mnt/db_backup_share/${SERVER_NAME}/
â”œâ”€â”€ base_backups/       # Full database backups
â”œâ”€â”€ wal_archive/        # WAL archive files
â””â”€â”€ autogenerated-reports/   # Performance reports
\`\`\`

---

## â° Scheduled Jobs


| **pg_basebackup** | Daily 11:59 PM | pg_basebackup.sh | 
-pg_basebackups for the entire instance plus sync to remote storage at \\192.168.180.161\db_backups$\CLAIMANTS-DB ; 
set mail alert to inform :
on success(alert SDBA operator group ) 
on failure (alert SDBA operator group) 

| WAL archive log backups and sync to remote storage at \\192.168.180.161\db_backups$\CLAIMANTS-DB | Every 5 min | wal_archive_sync.sh | 
no success alert for this. 
on failure (alert SDBA operator group) 

| **VACUUM ANALYZE** | Daily 2:00 AM | vacuum_analyze.sh 
on success(alert CLAIMANTS-SUPPORT operator group ) 
on failure (alert SDBA operator group)

| **Index Bloat Check** | Saturday 5:00 PM |
on success(alert CLAIMANTS-SUPPORT operator group with logs as .txt file attached to mail ) 
on failure (alert SDBA operator group)

| **pg_amcheck** | Daily 6:00 AM | pg_amcheck.sh | pg_amcheck_summary as a .log attachment (on that mail) : also make sure to sync the .log file to SMB path on \\192.168.180.161\db_backups$\CLAIMANTS-DB\autogenerated-reports
on success(alert CLAIMANTS-SUPPORT operator group ) 
on failure (alert SDBA operator group)

| **Log rotation**  (log_rotation_age every 2days at 6:00am combined with log_rotation_size = 100MB); including log rotation for pg_amcheck logs.
no success alert for this. but on failure (alert SDBA operator group) 

|**WAL archive cleanup** | every sunday at 6pm (copy derived log reports to \\192.168.180.161\db_backups$\CLAIMANTS-DB\scripts-and-reports)
set mail alert to inform :
on success(alert CLAIMANTS-SUPPORT operator group ) 
on failure (alert SDBA operator group)


| **Daily Perf Report** | Daily 4:00 PM | daily_perf_report.sh | 
Schedule a job to query a daily reporting job (everyday at 4pm), for CLAIMANT-DB with report title as "CLAIMANTS-DB Daily Performance Report". 
let the report include blocking transactions, most used queries or tables of day, memory and cpu usage of day. 
after generation of this report, only mail it to jerry.opolot@ursb.go.ug and moses.chicco@ursb.go.ug; everyday at 13:00
set mail subject to "CLAIMANTS-DB Daily Performance Report"

---


---

## âš™ï¸ System Alerts

1.
Database Down | PostgreSQL service not responding (alert CLAIMANTS-SUPPORT operator group)

2.
Disk Space Critical | Data/WAL disk > 90% full (alert SDBA operator group)
Disk Space (basis point):
  - Warning:  70% utilization
  - Critical: 85% utilization

3.
High CPU/Memory  | Resource utilization > 85%   (alert SDBA operator group)  

4.
Failed Login Attempts  Repeated authentication failures (alert SDBA operator group)  
alert basis:
configured to trigger mail alert only after 10 failed attempts within the last 15 minutes. 

5.
Temp File Usage  | Large temporary files being created (alert SDBA operator group) 

6.
Backup Age | Last backup older than expected  (alert SDBA operator group) 
Backup Age (basis points) :  
  - Critical:  35 hours ( for missed daily backup)



## ðŸ“‹ Post-Setup Checklist

After running the setup, check and verify:

1. **Verify Mounts**: `df -h | grep mnt`
2. **Test SMTP**: `echo "test" | msmtp your@email.com`
3. **Check Cron**: `crontab -l` (should show jobs)
4. **Test Backup**: `sudo /opt/pg-maintenance/scripts/pg_basebackup.sh`
5. **Monitor Logs**: `tail -f /opt/pg-maintenance/logs/system_monitor.log`

